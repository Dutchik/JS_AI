<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JSè‡ªä½œãƒ»å­¦ç¿’å‹ãƒãƒ£ãƒƒãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #111;
      color: #eee;
    }

    header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #181818;
      border-bottom: 1px solid #333;
    }

    .hamburger {
      width: 28px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      margin-right: 12px;
    }

    .hamburger span {
      display: block;
      height: 3px;
      background: #eee;
      border-radius: 2px;
    }

    .title {
      font-size: 16px;
      font-weight: 600;
    }

    .app {
      display: flex;
      height: calc(100vh - 42px);
    }

    .sidebar {
      width: 0;
      background: #151515;
      border-right: 1px solid #333;
      overflow: hidden;
      transition: width 0.2s ease;
    }

    .sidebar.open {
      width: 220px;
    }

    .sidebar-inner {
      padding: 8px;
      height: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .menu-section-title {
      font-size: 12px;
      color: #888;
      margin: 8px 0 4px;
    }

    .menu-item {
      padding: 6px 8px;
      margin-bottom: 4px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
      color: #ddd;
    }

    .menu-item.active {
      background: #333;
    }

    .menu-item:hover {
      background: #262626;
    }

    .main {
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
    }

    /* Homeï¼ˆå¯¾è©±ï¼‰UI */
    #homeView {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #chatLog {
      border: 1px solid #444;
      background: #000;
      padding: 8px;
      height: 360px;
      overflow-y: auto;
      font-size: 14px;
      white-space: pre-wrap;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      padding: 8px;
      resize: vertical;
      font-family: inherit;
      font-size: 13px;
    }

    button {
      margin-top: 4px;
      padding: 6px 10px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      cursor: pointer;
      font-size: 13px;
    }

    button:hover {
      background: #333;
    }

    .msg-user {
      color: #8fd1ff;
      margin-bottom: 4px;
    }

    .msg-bot {
      color: #ffd47f;
      margin-bottom: 8px;
    }

    .msg-note {
      color: #9acd32;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .small {
      font-size: 12px;
      color: #aaa;
    }

    #stats {
      margin-top: 4px;
      font-size: 12px;
      color: #aaa;
    }

    @media (max-width: 600px) {
      .app {
        flex-direction: row;
      }
      .sidebar.open {
        position: absolute;
        z-index: 10;
        height: calc(100vh - 42px);
      }
    }
  </style>
</head>
<body>
<header>
  <div id="menuToggle" class="hamburger" aria-label="menu">
    <span></span><span></span><span></span>
  </div>
  <div class="title">è‡ªä½œAIãƒãƒ–</div>
</header>

<div class="app">
  <nav id="sidebar" class="sidebar">
    <div class="sidebar-inner">
      <div class="menu-section-title">ãƒ¡ã‚¤ãƒ³</div>
      <div class="menu-item active" data-view="home">Homeï¼ˆå¯¾è©±ï¼‰</div>

      <div class="menu-section-title">æ‹¡å¼µï¼ˆAPIï¼‰</div>
      <div id="extensionMenu"></div>

      <div style="margin-top:auto;" class="small">
        JSã‚ªãƒ³ãƒªãƒ¼ / ãƒ­ãƒ¼ã‚«ãƒ«å­¦ç¿’<br>
        ãƒ¡ãƒ¢ãƒªæ•´ç†ã‚„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯æ‹¡å¼µã‹ã‚‰ã€‚
      </div>
    </div>
  </nav>

  <main id="main" class="main">
    <!-- Home viewï¼ˆå¯¾è©±UIã®ã¿ï¼‰ -->
    <div id="homeView">
      <div class="small">
        ãƒ»ã“ã®ç”»é¢ãŒãƒ¡ã‚¤ãƒ³ã®å¯¾è©±AIã€‚<br>
        ãƒ»è¿”ç­”ãŒã‚ºãƒ¬ã¦ãŸã‚‰ä¸‹ã§ä¿®æ­£ã—ã¦å­¦ç¿’ã•ã›ã‚ã€‚<br>
        ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„Webå­¦ç¿’ã¯å·¦ä¸Šãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‹ã‚‰æ‹¡å¼µã‚’å©ã‘ã€‚
      </div>

      <div id="chatLog"></div>

      <div>
        <label for="userInput" class="small">ã‚ãªãŸã®å…¥åŠ›:</label><br>
        <textarea id="userInput" rows="3"></textarea><br>
        <button id="sendBtn">é€ä¿¡</button>
      </div>

      <div>
        <label for="correctionInput" class="small">
          ç›´ã—ãŸã„Botã®è¿”ç­”ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦å…¥åŠ›ï¼ˆç›´å‰ã®ç™ºè¨€ã«é©ç”¨ï¼‰:
        </label><br>
        <textarea id="correctionInput" rows="3"
                  placeholder="ã“ã“ã«æ­£ã—ã„è¿”ç­”ã‚’æ›¸ã„ã¦ã€Œä¿®æ­£ã‚’å­¦ç¿’ã•ã›ã‚‹ã€ã‚’æŠ¼ã™"></textarea><br>
        <button id="applyCorrectionBtn">ä¿®æ­£ã‚’å­¦ç¿’ã•ã›ã‚‹</button>
      </div>

      <div id="stats"></div>
    </div>

    <!-- æ‹¡å¼µãƒ“ãƒ¥ãƒ¼ -->
    <div id="extensionView" style="display:none;"></div>
  </main>
</div>

<script>
  // ===== Brainï¼ˆã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ï¼‰=====
  class Brain {
    constructor() {
      this.memory = [];          // ç›´è¿‘ã®ä¼šè©±ãƒ­ã‚°ï¼ˆè©³ç´°ï¼‰
      this.archive = {           // å¤ã„ä¼šè©±ã®çµ±è¨ˆ
        tokenFreq: {},           // å˜èª -> ç´¯ç©é »åº¦
        totalUtterances: 0       // åœ§ç¸®ã«å›ã—ãŸç™ºè©±æ•°
      };
      this.nextId = 1;           // ä¼šè©±IDæ¡ç•ª
    }

    tokenize(text) {
      return text
        .toLowerCase()
        .replace(/[^a-z0-9ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾ ãƒ¼\s]/g, " ")
        .split(/\s+/)
        .filter(t => t.length > 0);
    }

    textToVector(text) {
      const tokens = this.tokenize(text);
      const vec = {};
      for (const t of tokens) {
        vec[t] = (vec[t] || 0) + 1;
      }
      return vec;
    }

    cosineSimilarity(a, b) {
      let dot = 0;
      let na = 0;
      let nb = 0;

      for (const k in a) {
        const x = a[k];
        na += x * x;
        if (k in b) {
          dot += x * b[k];
        }
      }
      for (const k in b) {
        const y = b[k];
        nb += y * y;
      }
      if (na === 0 || nb === 0) return 0;
      return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }

    learn(userText, botText) {
      const vec = this.textToVector(userText);
      const item = {
        id: this.nextId++,
        user: userText,
        bot: botText,
        corrected: false,
        ts: Date.now(),
        vec
      };
      this.memory.push(item);
      this.save();
      return item.id;
    }

    learnCorrection(id, correctedBotText) {
      const item = this.memory.find(m => m.id === id);
      if (!item) return;
      item.bot = correctedBotText;
      item.corrected = true;
      item.ts = Date.now();
      this.save();
    }

    findNearestReply(userText) {
      if (this.memory.length === 0) return null;
      const v = this.textToVector(userText);
      let best = null;
      let bestScore = -1;
      for (const m of this.memory) {
        const sim = this.cosineSimilarity(v, m.vec);
        let score = sim;
        if (m.corrected) score += 0.1;
        if (score > bestScore) {
          bestScore = score;
          best = m;
        }
      }
      if (bestScore < 0.2) return null;
      return best.bot;
    }

    reply(userText) {
      if (userText.includes("ç–²ã‚ŒãŸ")) {
        return "ç–²ã‚ŒãŸã®ã¯åˆ†ã‹ã‚‹ãŒã€æ™‚é–“ã®æ–¹ãŒãŠå‰ã«æ–‡å¥è¨€ã„ãŸã„ã¨æ€ã£ã¦ã‚‹ãã€‚";
      }
      if (userText.includes("ã‚„ã‚‹æ°—")) {
        return "ã‚„ã‚‹æ°—ã¯é™ã£ã¦ã“ãªã„ã€‚ã¾ãš1è¡Œã‚„ã‚Œã€ãã‚ŒãŒç€ç«å‰¤ã ã€‚";
      }

      const learned = this.findNearestReply(userText);
      if (learned) return learned;

      return "ã¾ã ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å­¦ç¿’ã—ã¦ãªã„ã€‚ãŠå‰ãŒä¿®æ­£ã—ã¦ãã‚Œã‚Œã°æ¬¡ã‹ã‚‰ã¯è¦šãˆã‚‹ã€‚";
    }

    compress(maxKeep = 500) {
      if (this.memory.length <= maxKeep) return;

      const excess = this.memory.length - maxKeep;
      const old = this.memory.slice(0, excess);
      const keep = this.memory.slice(excess);

      for (const m of old) {
        const tokensUser = this.tokenize(m.user);
        const tokensBot  = this.tokenize(m.bot);
        const tokens = tokensUser.concat(tokensBot);
        for (const tok of tokens) {
          this.archive.tokenFreq[tok] = (this.archive.tokenFreq[tok] || 0) + 1;
        }
        this.archive.totalUtterances += 1;
      }

      this.memory = keep;
      this.save();
    }

    toDataObject() {
      return {
        memory: this.memory,
        archive: this.archive,
        nextId: this.nextId
      };
    }

    fromDataObject(data) {
      this.memory  = Array.isArray(data.memory) ? data.memory : [];
      this.archive = data.archive || { tokenFreq: {}, totalUtterances: 0 };
      this.nextId  = typeof data.nextId === "number" ? data.nextId : 1;
      this.save();
    }

    save() {
      const data = this.toDataObject();
      try {
        localStorage.setItem("my_ai_brain", JSON.stringify(data));
      } catch (e) {
        console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š", e);
      }
    }

    load() {
      const raw = localStorage.getItem("my_ai_brain");
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        this.fromDataObject(data);
      } catch (e) {
        console.error("ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ï¼š", e);
      }
    }
  }

  // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼šBrain & æ‹¡å¼µç™»éŒ² =====
  const brain = new Brain();
  brain.load();
  window._brain = brain; // æ‹¡å¼µç”¨

  window.aiExtensions = [];
  function registerExtension(ext) {
    // { id, title, init(container, brain) } ã‚’æœŸå¾…
    if (!ext || !ext.id || !ext.title || !ext.init) return;
    window.aiExtensions.push(ext);
  }
  window.registerExtension = registerExtension;

  // ===== Homeãƒ“ãƒ¥ãƒ¼ã®UI =====
  const userInput = document.getElementById("userInput");
  const chatLog = document.getElementById("chatLog");
  const correctionInput = document.getElementById("correctionInput");
  const statsDiv = document.getElementById("stats");

  const homeView = document.getElementById("homeView");
  const extView = document.getElementById("extensionView");

  let lastMessageId = null;

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function appendLog(html) {
    chatLog.innerHTML += html + "\n";
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function updateStats() {
    const mem = brain.memory.length;
    const totalUtterances = brain.archive.totalUtterances;
    const vocabSize = Object.keys(brain.archive.tokenFreq).length;
    statsDiv.textContent =
      `è©³ç´°ãƒ­ã‚°: ${mem} ä»¶ / åœ§ç¸®æ¸ˆã¿ç™ºè©±: ${totalUtterances} / åœ§ç¸®å´èªå½™æ•°: ${vocabSize}`;
  }
  updateStats();
  window._updateStats = updateStats; // æ‹¡å¼µå´ã‹ã‚‰ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«

  document.getElementById("sendBtn").addEventListener("click", () => {
    const text = userInput.value.trim();
    if (!text) return;

    const botText = brain.reply(text);
    const id = brain.learn(text, botText);
    lastMessageId = id;

    appendLog(`ğŸ§‘ <span class="msg-user">${escapeHtml(text)}</span>`);
    appendLog(`ğŸ¤– <span class="msg-bot">${escapeHtml(botText)}</span>`);

    userInput.value = "";
    updateStats();
  });

  document.getElementById("applyCorrectionBtn").addEventListener("click", () => {
    const corrected = correctionInput.value.trim();
    if (!corrected || lastMessageId == null) return;

    brain.learnCorrection(lastMessageId, corrected);

    appendLog(`âœï¸ <span class="msg-note">ç›´å‰ã®Botè¿”ç­”ã‚’ä¿®æ­£å­¦ç¿’: ${escapeHtml(corrected)}</span>`);
    correctionInput.value = "";
    updateStats();
  });

  // ===== ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ & ãƒ¡ãƒ‹ãƒ¥ãƒ¼ =====
  const sidebar = document.getElementById("sidebar");
  const menuToggle = document.getElementById("menuToggle");
  const extMenu = document.getElementById("extensionMenu");

  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("open");
  });

  function setActiveMenuItem(el) {
    document.querySelectorAll(".menu-item").forEach(item => {
      item.classList.remove("active");
    });
    el.classList.add("active");
  }

  function showHome() {
    homeView.style.display = "";
    extView.style.display = "none";
  }

  function showExtension(ext) {
    homeView.style.display = "none";
    extView.style.display = "";
    extView.innerHTML = "";
    ext.init(extView, brain);
  }

  // åˆæœŸè¡¨ç¤º
  showHome();

  // Homeãƒ¡ãƒ‹ãƒ¥ãƒ¼
  document.querySelector('.menu-item[data-view="home"]').addEventListener("click", (e) => {
    setActiveMenuItem(e.currentTarget);
    showHome();
    sidebar.classList.remove("open");
  });

  // æ‹¡å¼µãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆ
  function buildExtensionMenu() {
    extMenu.innerHTML = "";
    window.aiExtensions.forEach(ext => {
      const item = document.createElement("div");
      item.className = "menu-item";
      item.textContent = ext.title;
      item.dataset.extId = ext.id;
      item.addEventListener("click", () => {
        setActiveMenuItem(item);
        showExtension(ext);
        sidebar.classList.remove("open");
      });
      extMenu.appendChild(item);
    });
  }
  window._buildExtensionMenu = buildExtensionMenu;
</script>

<!-- APIæ‹¡å¼µèª­ã¿è¾¼ã¿ -->
<script src="api/localDataManager.js"></script>
<script src="api/webTrainer.js"></script>

<script>
  // æ‹¡å¼µèª­ã¿è¾¼ã¿å¾Œã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰
  if (window._buildExtensionMenu) {
    window._buildExtensionMenu();
  }
</script>

</body>
</html>

