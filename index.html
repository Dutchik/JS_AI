<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JSè‡ªä½œãƒ»å­¦ç¿’å‹ãƒãƒ£ãƒƒãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --header-h: 48px;
      --sidebar-w: 230px;
      --bg: #111;
      --bg-elevated: #181818;
      --border: #333;
      --border-soft: #444;
      --text-main: #eee;
      --text-sub: #aaa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      height: var(--header-h);
    }

    .hamburger {
      width: 28px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      margin-right: 12px;
    }

    .hamburger span {
      display: block;
      height: 3px;
      background: var(--text-main);
      border-radius: 2px;
    }

    .title {
      font-size: 16px;
      font-weight: 600;
    }

    .app {
      display: flex;
      height: calc(100vh - var(--header-h));
      overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-w);
      background: #151515;
      border-right: 1px solid var(--border);
      overflow: hidden;
      transition: width 0.2s ease;
      flex-shrink: 0;
      position: relative;
    }

    .sidebar-inner {
      padding: 8px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .menu-section-title {
      font-size: 12px;
      color: #888;
      margin: 8px 0 4px;
    }

    .menu-item {
      padding: 6px 8px;
      margin-bottom: 4px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
      color: #ddd;
      transition: background 0.15s;
    }

    .menu-item.active { background: #333; }
    .menu-item:hover { background: #262626; }

    .sidebar-footer {
      margin-top: auto;
      font-size: 12px;
      color: var(--text-sub);
    }

    .main {
      flex: 1;
      padding: 10px;
      overflow: auto;
      display: flex;
      justify-content: center;
    }

    .main-inner {
      width: 100%;
      max-width: 960px;
    }

    #homeView {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #chatLog {
      border: 1px solid var(--border-soft);
      background: #000;
      padding: 8px;
      height: 420px;
      overflow-y: auto;
      font-size: 14px;
      white-space: pre-wrap;
    }

    textarea {
      width: 100%;
      background: #222;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
      padding: 8px;
      resize: vertical;
      font-family: inherit;
      font-size: 13px;
      border-radius: 4px;
    }

    button {
      margin-top: 4px;
      padding: 6px 10px;
      border: 1px solid #555;
      background: #222;
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px;
    }

    button:hover { background: #333; }

    .msg-user  { color: #8fd1ff; margin-bottom: 4px; }
    .msg-bot   { color: #ffd47f; margin-bottom: 8px; }
    .msg-note  { color: #9acd32; font-size: 12px; margin-bottom: 8px; }
    .small     { font-size: 12px; color: var(--text-sub); }
    #stats     { margin-top: 4px; font-size: 12px; color: var(--text-sub); }

    #extensionView {}

    .model-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    select {
      background: #222;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    @media (max-width: 900px) {
      .app { position: relative; }

      .sidebar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0;
        box-shadow: 0 0 20px rgba(0,0,0,0.6);
        z-index: 10;
      }

      .sidebar.open { width: var(--sidebar-w); }

      .main { padding: 8px; }
      .main-inner { max-width: 100%; }
      #chatLog { height: 55vh; }
    }

    @media (min-width: 901px) {
      .sidebar { width: var(--sidebar-w); }
      .sidebar.open { width: var(--sidebar-w); }
    }
  </style>
</head>
<body>
<header>
  <div id="menuToggle" class="hamburger" aria-label="menu">
    <span></span><span></span><span></span>
  </div>
  <div class="title">è‡ªä½œAIãƒãƒ–</div>
</header>

<div class="app">
  <nav id="sidebar" class="sidebar">
    <div class="sidebar-inner">
      <div class="menu-section-title">ãƒ¡ã‚¤ãƒ³</div>
      <div class="menu-item active" data-view="home">Homeï¼ˆå¯¾è©±ï¼‰</div>

      <div class="menu-section-title">æ‹¡å¼µï¼ˆAPIï¼‰</div>
      <div id="extensionMenu"></div>

      <div class="sidebar-footer">
        JSã‚ªãƒ³ãƒªãƒ¼ / ãƒ¢ãƒ‡ãƒ«å·®ã—æ›¿ãˆåˆ¶<br>
        ãƒ¢ãƒ‡ãƒ«ã¯ models/ ã®JSã§è¿½åŠ ã€‚
      </div>
    </div>
  </nav>

  <main id="main" class="main">
    <div class="main-inner">
      <div id="homeView">
        <div class="small">
          ãƒ»ã“ã®ç”»é¢ãŒãƒ¡ã‚¤ãƒ³ã®å¯¾è©±AIã€‚<br>
          ãƒ»è¿”ç­”ãŒã‚ºãƒ¬ã¦ãŸã‚‰ä¸‹ã§ä¿®æ­£ã—ã¦å­¦ç¿’ã•ã›ã‚ã€‚<br>
          ãƒ»ãƒ¢ãƒ‡ãƒ«ã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã€‚<br>
          ãƒ»æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã¯ models/ ã«JSã‚’ç½®ã„ã¦ registerModel ã™ã‚Œã°è¿½åŠ ã•ã‚Œã‚‹ã€‚
        </div>

        <div class="model-row">
          <span class="small">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:</span>
          <select id="modelSelect"></select>
          <span id="modelInfo" class="small"></span>
        </div>

        <div id="chatLog"></div>

        <div>
          <label for="userInput" class="small">ã‚ãªãŸã®å…¥åŠ›:</label><br>
          <textarea id="userInput" rows="3"></textarea><br>
          <button id="sendBtn">é€ä¿¡</button>
        </div>

        <div>
          <label for="correctionInput" class="small">
            ç›´ã—ãŸã„Botã®è¿”ç­”ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦å…¥åŠ›ï¼ˆç›´å‰ã®ç™ºè¨€ã«é©ç”¨ï¼‰:
          </label><br>
          <textarea id="correctionInput" rows="3"
                    placeholder="ã“ã“ã«æ­£ã—ã„è¿”ç­”ã‚’æ›¸ã„ã¦ã€Œä¿®æ­£ã‚’å­¦ç¿’ã•ã›ã‚‹ã€ã‚’æŠ¼ã™"></textarea><br>
          <button id="applyCorrectionBtn">ä¿®æ­£ã‚’å­¦ç¿’ã•ã›ã‚‹</button>
        </div>

        <div id="stats"></div>
      </div>

      <div id="extensionView" style="display:none;"></div>
    </div>
  </main>
</div>

<script>
  // ===== ãƒ¢ãƒ‡ãƒ«ç™»éŒ² =====
  window.aiModels = [];
  function registerModel(def) {
    // { id, name, description, createInstance(storageKey) }
    if (!def || !def.id || !def.name || !def.createInstance) return;
    window.aiModels.push(def);
  }
  window.registerModel = registerModel;

  // ===== æ‹¡å¼µç™»éŒ² =====
  window.aiExtensions = [];
  function registerExtension(ext) {
    if (!ext || !ext.id || !ext.title || !ext.init) return;
    window.aiExtensions.push(ext);
  }
  window.registerExtension = registerExtension;

  // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ =====
  let brain = null;
  let currentModelId = null;

  const userInput       = document.getElementById("userInput");
  const chatLog         = document.getElementById("chatLog");
  const correctionInput = document.getElementById("correctionInput");
  const statsDiv        = document.getElementById("stats");
  const homeView        = document.getElementById("homeView");
  const extView         = document.getElementById("extensionView");
  const modelSelect     = document.getElementById("modelSelect");
  const modelInfo       = document.getElementById("modelInfo");

  let lastMessageId = null;

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function appendLog(html) {
    chatLog.innerHTML += html + "\n";
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function updateStats() {
    if (!brain) {
      statsDiv.textContent = "ãƒ¢ãƒ‡ãƒ«æœªé¸æŠ";
      return;
    }
    const mem      = brain.memory ? brain.memory.length : 0;
    const archive  = brain.archive || { totalUtterances: 0, tokenFreq: {} };
    const total    = archive.totalUtterances || 0;
    const vocab    = archive.tokenFreq ? Object.keys(archive.tokenFreq).length : 0;

    statsDiv.textContent =
      `ãƒ¢ãƒ‡ãƒ«: ${currentModelId || "ãªã—"} / è©³ç´°ãƒ­ã‚°: ${mem} ä»¶ / åœ§ç¸®æ¸ˆã¿ç™ºè©±: ${total} / åœ§ç¸®å´èªå½™æ•°: ${vocab}`;
  }
  window._updateStats = updateStats;

  // ===== ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆ =====
  function rebuildModelSelect() {
    modelSelect.innerHTML = "";
    if (window.aiModels.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ãƒ¢ãƒ‡ãƒ«ãªã—";
      modelSelect.appendChild(opt);
      modelInfo.textContent = "models/ ã«ãƒ¢ãƒ‡ãƒ«JSã‚’è¿½åŠ ã—ã‚ã€‚";
      return;
    }
    window.aiModels.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      modelSelect.appendChild(opt);
    });
  }

  function switchModel(id) {
    const def = window.aiModels.find(m => m.id === id);
    if (!def) {
      brain = null;
      currentModelId = null;
      window._brain = null;
      updateStats();
      modelInfo.textContent = "ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€‚";
      return;
    }
    currentModelId = def.id;
    const storageKey = "my_ai_brain_" + def.id;
    brain = def.createInstance(storageKey);
    window._brain = brain;
    modelInfo.textContent = def.description || "";
    updateStats();
  }

  modelSelect.addEventListener("change", () => {
    const id = modelSelect.value;
    switchModel(id);
  });

  // ===== Home UI =====
  document.getElementById("sendBtn").addEventListener("click", () => {
    if (!brain) {
      appendLog(`âš ï¸ <span class="msg-note">ãƒ¢ãƒ‡ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã€‚ã¾ãšä¸Šã§ãƒ¢ãƒ‡ãƒ«ã‚’é¸ã¹ã€‚</span>`);
      return;
    }
    const text = userInput.value.trim();
    if (!text) return;

    const botText = brain.reply(text);
    const id = brain.learn(text, botText);
    lastMessageId = id;

    appendLog(`ğŸ§‘ <span class="msg-user">${escapeHtml(text)}</span>`);
    appendLog(`ğŸ¤– <span class="msg-bot">${escapeHtml(botText)}</span>`);

    userInput.value = "";
    updateStats();
  });

  document.getElementById("applyCorrectionBtn").addEventListener("click", () => {
    if (!brain) return;
    const corrected = correctionInput.value.trim();
    if (!corrected || lastMessageId == null) return;

    brain.learnCorrection(lastMessageId, corrected);
    appendLog(`âœï¸ <span class="msg-note">ç›´å‰ã®Botè¿”ç­”ã‚’ä¿®æ­£å­¦ç¿’: ${escapeHtml(corrected)}</span>`);
    correctionInput.value = "";
    updateStats();
  });

  // ===== ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ»æ‹¡å¼µ =====
  const sidebar  = document.getElementById("sidebar");
  const menuToggle = document.getElementById("menuToggle");
  const extMenu  = document.getElementById("extensionMenu");

  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("open");
  });

  function setActiveMenuItem(el) {
    document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
    el.classList.add("active");
  }

  function showHome() {
    homeView.style.display = "";
    extView.style.display  = "none";
  }

  function showExtension(ext) {
    homeView.style.display = "none";
    extView.style.display  = "";
    extView.innerHTML      = "";
    if (!brain) {
      extView.innerHTML = `<div class="small">ã¾ãšãƒ¢ãƒ‡ãƒ«ã‚’é¸ã¹ã€‚è„³ã¿ããŒãªã„ã¨æ‹¡å¼µã‚‚å‹•ã‹ãªã„ã€‚</div>`;
      return;
    }
    ext.init(extView, brain);
  }

  showHome();

  document.querySelector('.menu-item[data-view="home"]').addEventListener("click", (e) => {
    setActiveMenuItem(e.currentTarget);
    showHome();
    sidebar.classList.remove("open");
  });

  function buildExtensionMenu() {
    extMenu.innerHTML = "";
    window.aiExtensions.forEach(ext => {
      const item = document.createElement("div");
      item.className = "menu-item";
      item.textContent = ext.title;
      item.dataset.extId = ext.id;
      item.addEventListener("click", () => {
        setActiveMenuItem(item);
        showExtension(ext);
        sidebar.classList.remove("open");
      });
      extMenu.appendChild(item);
    });
  }
  window._buildExtensionMenu = buildExtensionMenu;
</script>

<!-- â–¼ ãƒ¢ãƒ‡ãƒ«ç¾¤ï¼šã“ã“ã« models/*.js ã‚’è¿½åŠ ã—ã¦ã„ã â–¼ -->
<script src="models/simple_bow_v1.js"></script>
<script src="models/semantic_brain_v1.js"></script>
<!-- è¿½åŠ ãƒ¢ãƒ‡ãƒ«ã¯åŒã˜ã‚ˆã†ã«1è¡Œè¶³ã™ã ã‘ -->

<!-- â–¼ APIæ‹¡å¼µé¡ï¼ˆæ—¢å­˜ã®ã‚„ã¤ï¼‰ â–¼ -->
<script src="api/localDataManager.js"></script>
<script src="api/webTrainer.js"></script>
<script src="api/datasetUploader.js"></script>
<script src="api/dataCatalog.js"></script>

<script>
  // åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  rebuildModelSelect();
  if (window.aiModels.length > 0) {
    modelSelect.value = window.aiModels[0].id;
    switchModel(window.aiModels[0].id);
  }
  if (window._buildExtensionMenu) {
    window._buildExtensionMenu();
  }
</script>

</body>
</html>